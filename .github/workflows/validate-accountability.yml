name: Validate Accountability

on:
  pull_request:
    branches:
      - main
      - dev
  push:
    branches:
      - main
      - dev

jobs:
  check-accountability:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need at least 2 commits to compare HEAD~1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml>=6.0.1

      - name: Check validation edge accountability
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          python scripts/check_accountability.py

      - name: Comment on PR (if failed)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âœ— Accountability Check Failed

              This PR modifies validation edge(s), but the commit was not made by the accountable party listed in the frontmatter.

              **Important:** Validation edges can only be committed by:
              - For \`manual\` validation: the person listed in the \`validator\` field
              - For \`llm-assisted\` or \`automated\`: the person listed in the \`human_approver\` field

              This ensures clear accountability and trust in the validation process.

              Please ensure that:
              1. The validation edge is committed by the accountable party, OR
              2. The frontmatter is updated to list the actual committer as the accountable party (and they accept responsibility)

              See the workflow logs for details on which file(s) failed the check.`
            })
