# Assurance Audit Tooling Guide

This guide explains how to use the scripts and tools for creating and verifying assurance audit trails.

## Overview

The assurance audit toolchain includes:
- **Verification tools:** Automated structural checking
- **Audit tools:** Validate complete assurance trails
- **Accountability tools:** Check human attribution
- **Visualization tools:** Display audit results

## Verification Tools

### verify_template_based.py

Verifies a document conforms to its template specification.

**Usage:**
```bash
python scripts/verify_template_based.py <document> --templates <template-dir>
```

**Example:**
```bash
python scripts/verify_template_based.py 00_vertices/spec-for-charts.md --templates templates
```

**Output:**
```
Verifying: 00_vertices/spec-for-charts.md
Template: templates/00_vertices/spec.md

Checking frontmatter...
  ✓ Frontmatter present
  ✓ Field 'type' present and correct type
  ✓ Field 'id' present and correct type
  ✓ Field 'name' present and correct type
  ✓ All required fields present

Checking body structure...
  ✓ Required sections present
  ✓ Section order correct

Verification: PASS
```

**Exit Codes:**
- `0`: Verification passed
- `1`: Verification failed

**Creating Verification Edge:**

After running verification, document the result in a verification edge:

```yaml
---
type: edge/verification
id: e:verification:chart:spec
source: v:spec:chart
target: v:spec:spec
---

# Verification Report

**Tool:** verify_template_based.py
**Date:** 2025-12-27T14:00:00Z
**Result:** PASS

## Checks Performed

- Frontmatter structure: ✓ PASS
- Required fields: ✓ PASS
- Field types: ✓ PASS
- Body sections: ✓ PASS

## Accountability

**Generated By:** verify_template_based.py v1.0.0
**Reviewed By:** Chief Engineer
**Date:** 2025-12-27T14:05:00Z
```

### build_cache.py

Builds element cache and validates all documents in the repository.

**Usage:**
```bash
python scripts/build_cache.py [--path <directory>]
```

**Example:**
```bash
# Verify all documents in repository
python scripts/build_cache.py

# Verify specific directory
python scripts/build_cache.py --path 00_vertices
```

**Output:**
```
Building cache...
Parsing vertices: 45 files
Parsing edges: 67 files
Parsing faces: 38 files
Parsing charts: 3 files

Validating structure...
  ✓ All vertices valid
  ✓ All edges valid
  ✓ All faces valid
  ✓ All charts valid

Cache built: complex.json
```

**Use Case:** Run before committing to ensure no broken documents.

## Audit Tools

### audit_assurance_chart.py

Validates that all vertices in a chart have complete assurance trails.

**Usage:**
```bash
python scripts/audit_assurance_chart.py <chart-file>
```

**Example:**
```bash
python scripts/audit_assurance_chart.py charts/chart-types-audit/chart-types-audit.md
```

**Output:**
```
Assurance Audit for Chart: chart-types-audit
==============================================

Checking vertex: v:spec:chart
  ✓ Assurance face found: f:assurance:chart
  ✓ Verification edge found: e:verification:chart:spec
  ✓ Validation edge found: e:validation:chart:guidance
  ✓ Traces to root: b0:root

Checking vertex: v:spec:assurance_audit
  ✓ Assurance face found: f:assurance:assurance_audit
  ✓ Verification edge found: e:verification:assurance_audit:spec
  ✓ Validation edge found: e:validation:assurance_audit:guidance
  ✓ Traces to root: b0:root

... (more vertices)

Summary:
--------
Vertices to Assure: 9
Assured Vertices: 9 (100%)

All vertices are assured!
Audit: PASS ✓
```

**Audit Checks:**
1. For each vertex, does an assurance face exist?
2. Does the assurance face reference the vertex?
3. Does the assurance face have a verification edge?
4. Does the assurance face have a validation edge?
5. Do the edges trace back to the root boundary anchor?

**Exit Codes:**
- `0`: Audit passed (100% assured)
- `1`: Audit failed (missing assurance)

**Failed Audit Example:**
```
Checking vertex: v:spec:foo
  ✗ No assurance face found
  Missing: f:assurance:foo

Summary:
--------
Vertices to Assure: 10
Assured Vertices: 9 (90%)

Missing Assurance:
- v:spec:foo

Audit: FAIL ✗
```

### check_accountability.py

Checks that accountability statements are present and valid in edges.

**Usage:**
```bash
python scripts/check_accountability.py <edge-file>
```

**Example:**
```bash
# Check verification edge
python scripts/check_accountability.py 01_edges/verification-chart:spec.md

# Check validation edge
python scripts/check_accountability.py 01_edges/validation-chart:guidance.md
```

**Output (Valid):**
```
Checking accountability: 01_edges/validation-chart:guidance.md

✓ Accountability section found
✓ Reviewer field present: Chief Engineer
✓ Date field present: 2025-12-27T15:30:00Z
✓ Authority field present: Repository maintainer
✓ Result field present: APPROVED

Accountability: VALID ✓
```

**Output (Invalid):**
```
Checking accountability: 01_edges/validation-foo:guidance.md

✗ Accountability section NOT found
✗ Missing required fields: Reviewer, Date, Authority, Result

Accountability: INVALID ✗
```

**Required Fields for Validation Edges:**
- `Reviewer`: Name/identifier of human reviewer
- `Date`: ISO 8601 timestamp of review
- `Authority`: Why the reviewer is qualified
- `Result`: APPROVED or specific issues

**Required Fields for Verification Edges:**
- `Generated By`: Tool name and version
- `Reviewed By`: Human who verified tool ran correctly
- `Date`: ISO 8601 timestamp of review

## Topology Tools

### topology.py

Analyzes topological properties of a chart (Euler characteristic, holes).

**Usage:**
```bash
python scripts/topology.py <chart-file> [--json]
```

**Example:**
```bash
python scripts/topology.py charts/chart-types-audit/chart-types-audit.md
```

**Output:**
```
Chart: chart-types-audit
========================

Vertices (V): 9
Edges (E): 12
Faces (F): 4

Euler Characteristic (χ): 1
  χ = V - E + F
  χ = 9 - 12 + 4
  χ = 1

Topological Analysis:
- Expected χ for complete structure: 2
- Actual χ: 1
- Difference: -1
- Interpretation: 1 potential hole or boundary

Potential Faces (holes):
(No additional complete triangles detected)
```

**JSON Output:**
```bash
python scripts/topology.py charts/chart-types-audit/chart-types-audit.md --json
```

```json
{
  "chart": "chart-types-audit",
  "vertices": 9,
  "edges": 12,
  "faces": 4,
  "euler_characteristic": 1,
  "potential_faces": []
}
```

## Visualization Tools

### export_chart_direct.py

Exports a chart to JSON format for visualization.

**Usage:**
```bash
python scripts/export_chart_direct.py <chart.md> <output.json>
```

**Example:**
```bash
python scripts/export_chart_direct.py \
  charts/chart-types-audit/chart-types-audit.md \
  charts/chart-types-audit/chart-types-audit.json
```

**Output:** JSON file with full chart structure (vertices, edges, faces).

### visualize_chart.py

Creates an HTML visualization of a chart.

**Usage:**
```bash
python scripts/visualize_chart.py <chart.json>
```

**Example:**
```bash
python scripts/visualize_chart.py charts/chart-types-audit/chart-types-audit.json
```

**Output:** HTML file with interactive 3D visualization.

**Viewing:**
```bash
# Open in default browser
open charts/chart-types-audit/chart-types-audit.html
```

**Interaction:**
- Rotate: Click and drag
- Zoom: Scroll wheel
- Pan: Right-click and drag
- Hover: Mouse over elements to see details

## Common Workflows

### Workflow 1: Verify a Single Document

```bash
# 1. Verify structure
python scripts/verify_template_based.py 00_vertices/spec-for-foo.md --templates templates

# 2. Create verification edge (manual)
vim 01_edges/verification-foo:spec.md

# 3. Check accountability
python scripts/check_accountability.py 01_edges/verification-foo:spec.md
```

### Workflow 2: Complete Assurance for a Document

```bash
# 1. Verify structure
python scripts/verify_template_based.py 00_vertices/spec-for-foo.md --templates templates

# 2. Create verification edge
vim 01_edges/verification-foo:spec.md

# 3. Perform human validation (review against guidance)
# (Human reviews spec-for-foo against guidance-for-spec)

# 4. Create validation edge
vim 01_edges/validation-foo:spec.md

# 5. Check accountability for both edges
python scripts/check_accountability.py 01_edges/verification-foo:spec.md
python scripts/check_accountability.py 01_edges/validation-foo:spec.md

# 6. Create assurance face
vim 02_faces/assurance-foo.md

# 7. Add to chart and audit
python scripts/audit_assurance_chart.py charts/my-chart/my-chart.md
```

### Workflow 3: Full Repository Audit

```bash
# 1. Verify all documents
python scripts/build_cache.py

# 2. Audit all charts
for chart in charts/*/*.md; do
    if [[ "$chart" != *"TEACHING"* ]] && [[ "$chart" != *"README"* ]]; then
        echo "Auditing: $chart"
        python scripts/audit_assurance_chart.py "$chart"
    fi
done

# 3. Check topology
for chart in charts/*/*.md; do
    if [[ "$chart" != *"TEACHING"* ]] && [[ "$chart" != *"README"* ]]; then
        echo "Topology: $chart"
        python scripts/topology.py "$chart"
    fi
done
```

### Workflow 4: Create Visualization

```bash
# 1. Export to JSON
python scripts/export_chart_direct.py \
  charts/my-chart/my-chart.md \
  charts/my-chart/my-chart.json

# 2. Generate HTML visualization
python scripts/visualize_chart.py charts/my-chart/my-chart.json

# 3. Open in browser
open charts/my-chart/my-chart.html
```

## Continuous Integration

### Pre-Commit Hook

Add to `.git/hooks/pre-commit`:

```bash
#!/bin/bash

echo "Running verification checks..."

# Verify all documents
python scripts/build_cache.py
if [ $? -ne 0 ]; then
    echo "❌ Document verification failed"
    exit 1
fi

# Audit all charts
for chart in charts/*/*.md; do
    if [[ "$chart" != *"TEACHING"* ]] && [[ "$chart" != *"README"* ]]; then
        python scripts/audit_assurance_chart.py "$chart"
        if [ $? -ne 0 ]; then
            echo "❌ Assurance audit failed: $chart"
            exit 1
        fi
    fi
done

echo "✅ All checks passed"
exit 0
```

### CI/CD Pipeline

```yaml
# .github/workflows/verify.yml
name: Verify Knowledge Complex

on: [push, pull_request]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: pip install -r requirements.txt
      - name: Build cache
        run: python scripts/build_cache.py
      - name: Audit charts
        run: |
          for chart in charts/*/*.md; do
            if [[ "$chart" != *"TEACHING"* ]] && [[ "$chart" != *"README"* ]]; then
              python scripts/audit_assurance_chart.py "$chart"
            fi
          done
```

## Troubleshooting

### Verification Fails: Missing Fields

**Problem:**
```
✗ Field 'dependencies' missing
```

**Solution:** Add missing field to document frontmatter:
```yaml
dependencies: []
```

### Audit Fails: Missing Assurance Face

**Problem:**
```
✗ No assurance face found for v:spec:foo
```

**Solution:** Create assurance face `02_faces/assurance-foo.md` referencing the vertex.

### Accountability Check Fails: Missing Reviewer

**Problem:**
```
✗ Missing required field: Reviewer
```

**Solution:** Add accountability section to validation edge:
```markdown
## Accountability

**Reviewer:** Chief Engineer
**Date:** 2025-12-27T15:30:00Z
**Authority:** Repository maintainer
**Result:** APPROVED
```

### Topology Shows Unexpected Holes

**Problem:**
```
Potential Faces (holes): 3
```

**Solution:** Check if faces are missing. Run:
```bash
python scripts/topology.py charts/my-chart/my-chart.md --json
```

Review `potential_faces` array for triangles that could be added.

## Related Documentation

- [Audit Trail Walkthrough](audit-trail.md) - Step-by-step example
- [Triangle Pattern Explained](triangle-pattern.md) - Theory and concepts
- [Validation & Accountability](../../concepts/validation-accountability.md) - Governance concepts

---

**Tip:** Run `python scripts/build_cache.py` and `python scripts/audit_assurance_chart.py` frequently during development to catch issues early.
